(()=>{const e=()=>{dbService.collection("users").orderBy("logDate","desc").onSnapshot((e=>{$user.html(""),e.docs.map((e=>{const t=e.data();$user.append(`<li data-id=${e.id} data-uid=${t.uid} class=${t.loggedIn?"on":""}>${t.uname} <span>(${moment(t.logDate).format("YY-MM-DD a h:mm")})</span><button class="btn_out">탈퇴</button></li>`)}))}))};authService.onAuthStateChanged((async e=>{if(e)try{if(e.email===FBU_ADMIN||e.email===FBU_SUB_ADMIN?$userList.css("display","block"):$userList.remove(),$(".blog_write_btns").css("display","block"),e.emailVerified)$tweet_loading_all.show(),$(".code_open").show(),USER_NAME=e.displayName,USER_ID=e.uid,currentPathname(),$tweet_list_all.show(),$tweet_input_all.show(),getPostsAll(),(()=>{const e=authService.currentUser;e.emailVerified&&(currentPathname(),$popup_tweet_all.show(),$("#user_timer_new").text(moment(e.metadata.lastSignInTime).format("YYYY-MM-DD")),$("#user_timer_signup").text(moment(e.metadata.creationTime).format("YYYY-MM-DD")),$(".user_info#authorized").find("span").text(e.displayName),$(".user_info#authorized").find("em").text(e.email),$(".user_info#anonymous").remove(),$(".user_info#authorized").show(),$("#gnb li.authorized").find("span").text(e.displayName),$("#gnb li.authorized").find("em").text(e.email),$("#gnb li.anonymous").remove(),$("#gnb li.authorized").show(),$item_util.addClass("on"),$(".mo_menu_wrp").html($("#gnb ul").clone()),$("#profilePopup").find(".input_base").val(e.displayName),USER_NAME=e.displayName,USER_ID=e.uid,(async()=>{const e=(await userRef.where("uid","==",USER_ID).get()).docs.map((e=>({id:e.id,...e.data()})));e.length?(USER_DOC_ID=e[0].id,userRef.doc(USER_DOC_ID).update({loggedIn:!0,logDate:Date.now()})):userRef.add({loggedIn:!0,logDate:Date.now(),uid:USER_ID,uname:USER_NAME}).then((e=>{USER_DOC_ID=e.id}))})())})();else{if(window.location.pathname.indexOf("auth_email_retry.asp")<=0&&window.location.pathname.indexOf("signup.asp")<=0)confirm("이메일 인증이 필요합니다. 이메일 인증을 진행하시겠습니까?")?location.replace("./auth_email_retry.asp"):(deleteCookie(FBU_EMAIL),deleteCookie(FBU_PWD));else{const e=getCookie(FBU_EMAIL);e?($("#signupEmailAuthPage").find("#input_id").val(e),$("#signupEmailAuthPage").find("#input_name").focus()):$("#signupEmailAuthPage").find("#input_id").focus()}$(".mo_menu_wrp").html($("#gnb ul").clone()),$item_util.addClass("on")}PAGE_BLOG_DETAIL&&(getBlogItem(),getBlogCommentItem(),e.uid===FBU_ADMIN_UID&&$("#comment_list li").append('<button class="btn_delete_comment">삭제</button>'))}catch(e){console.log(e)}else $tweet_list_all.hide(),$tweet_input_all.hide(),$tweet_list_item.hide(),$tweet_input_item.hide(),$(".code_open").hide(),PAGE_BLOG||PAGE_BLOG_DETAIL||($loading_all.hide(),$loading_all_ui.hide()),PAGE_BLOG_DETAIL&&(getBlogItem(),getBlogCommentItem()),$(".mo_menu_wrp").html($("#gnb ul").clone()),setTimeout((function(){$item_util.addClass("on")}),700)})),e(),(()=>{const e=getCookie(FBU_EMAIL),t=getCookie(FBU_PWD);if(e&&t){const n=CryptoJS.AES.decrypt(t,SECRET_KEY);(async(e,t,n)=>{try{setCookie(FBU_EMAIL,e,7),setCookie(FBU_PWD,getEncrypted(t),7),await authService.signInWithEmailAndPassword(e,t),$(".user_info.pending").removeClass("pending"),$("#loginPage").find(".login_logo").removeClass("pending"),PAGE_LOGIN&&window.location.replace("./index.asp")}catch(e){console.log("error : ",e),n?$(".guide-header .user_info.pending, .login_logo.pending").removeClass("pending"):"auth/user-not-found"===e.code?(toastr.error("없는 회원입니다!"),$("#loginPage").find("#input_pw").val(""),$("#loginPage").find("#input_id").val("").focus(),$(".guide-header .user_info.pending, .login_logo.pending").removeClass("pending")):"auth/invalid-email"===e.code?($(".guide-header .user_info.pending, .login_logo.pending").removeClass("pending"),toastr.error("유효하지 않은 회원입니다.")):(toastr.error("비밀번호가 틀렸습니다!"),$("#loginPage").find(".login_logo").removeClass("pending"))}})(e,JSON.parse(n.toString(CryptoJS.enc.Utf8)),!0)}else $(".user_info.pending").removeClass("pending")})(),window.addEventListener("beforeunload",(function(t){authService.signOut(),userRef.doc(USER_DOC_ID).update({loggedIn:!1,logDate:Date.now()}),e()})),$user.on("click",".btn_out",(function(){if(window.confirm("유저를 탈퇴 시키시겠습니까?")){const e=$(this).closest("li").data("id");dbService.doc(`users/${e}`).delete(),window.location.replace("./index.asp")}}))})(),(()=>{let e="";tinymce.init({language:"ko_KR",selector:PAGE_BLOG?"#blogEditor":"#blogEditEditor",height:500,menubar:!1,plugins:["advlist","autolink","lists","link","image","charmap","preview","anchor","searchreplace","visualblocks","code","fullscreen","insertdatetime","media","table","code","help","wordcount","save"],toolbar:"formatselect fontselect fontsizeselect | forecolor backcolor | bold italic underline strikethrough | alignjustify alignleft aligncenter alignright | bullist numlist | table tabledelete | link image",image_title:!0,automatic_uploads:!0,setup:function(e){},file_picker_types:"image",file_picker_callback:function(t,n,i){var o=document.createElement("input");o.setAttribute("type","file"),o.setAttribute("accept","image/*"),o.onchange=function(n){var i=this.files[0];if(i.size>=2e6)return alert("파일 사이즈가 2MB를 넘어갑니다. 사진 용량을 줄여주세요.");var o=new FileReader;o.onload=function(){var e="blobid"+(new Date).getTime(),n=tinymce.activeEditor.editorUpload.blobCache,s=o.result.split(",")[1],a=n.create(e,i,s);n.add(a),t(a.blobUri(),{title:i.name})},o.onloadend=function(t){e=t.currentTarget.result},o.readAsDataURL(i)},o.click()},content_style:'body { font-family:"NotoSans KR", sans-serif; font-size:14px }'}),$blog_write_file.on("change",(function(t){const n=new FileReader;if(t.target.files[0].size>=2e6)return $(this).val(""),alert("파일 사이즈가 2MB를 넘어갑니다. 사진 용량을 줄여주세요.");n.onloadend=t=>{e=t.currentTarget.result,$(".preview_wrp").html(`<img src=${t.currentTarget.result} alt="" />`)},n.readAsDataURL(t.target.files[0])})),$blog_write_btn.on("click",(function(e){e.preventDefault(),$blog_write.addClass("on"),$("body").addClass("no_scroll"),setTimeout((function(){$blog_write.addClass("active")}),250)})),$blog_write_close_btn.on("click",(function(e){e.preventDefault(),$blog_write.removeClass("on"),$("body").removeClass("no_scroll"),$blog_write.removeClass("active")})),(PAGE_BLOG||PAGE_BLOG_DETAIL)&&$(".ank").remove(),$blog_write.find("#btnSave").on("click",(t=>{(async()=>{try{var t=await tinymce.activeEditor.getContent();let n="";if(""!==e){const t=storageService.ref().child(`${USER_ID}/${Math.random()}`),i=await t.putString(e,"data_url");n=await i.ref.getDownloadURL()}const i=$blog_write.find(".blog_title").val();if(""===i.trim())return toastr.error("제목을 입력하세요!"),void $blog_write.find(".blog_title").focus();const o={title:i,content:t,createdAt:Date.now(),author:USER_NAME,creatorId:USER_ID,attachmentUrl:n,comments:[]};await blogRef.add(o).then((t=>{$blog_write.find(".blog_title").val(""),$blog_write.find(".blog_content").val(""),e="",location.href=`./blog_detail.asp?id=${t.id}`,toastr.success("글을 작성했습니다.")})).catch((e=>{console.error(e),toastr.error(e)}))}catch(e){console.error(err),toastr.error(e)}})()})),$blog_edit.find("#btnEdit").on("click",(e=>{(async e=>{try{var t=await tinymce.activeEditor.getContent();await dbService.doc(`blogs/${e}`).update({title:$(".blog_edit_title").val(),content:t}),toastr.success("글을 수정했습니다."),$(".page_name_wrap h3.page_name").text($(".blog_edit_title").val()),$blog_detail.find(".content_wrp").html(t),$blog_detail.show(),$blog_edit.hide()}catch(e){console.error(e),toastr.error(e)}})($.urlParam("id"))})),$blog_detail.find("#btnDelete").on("click",(e=>{e.preventDefault(),confirm("정말 삭제하시겠습니까?")&&(async e=>{try{await dbService.doc(`blogs/${e}`).delete()}catch(e){console.error(e)}finally{location.href="./blog.asp"}})($.urlParam("id"))})),$blog_detail.find("#btnModify").on("click",(e=>{e.preventDefault(),$blog_detail.hide(),$blog_edit.show()})),$blog_comment_write.find("#btnSave").on("click",(e=>{(async()=>{try{const e=$.urlParam("id"),t=$blog_comment_write.find(".comment_content").val();if(t.length>4999)return toastr.error("5000자 이상 입력할 수 없습니다.");if(""===t.trim())return toastr.error("값을 입력하세요.");const n={content:t,createdAt:Date.now(),author:USER_NAME||"손님",creatorId:USER_ID},i=(await dbService.doc(`blogs/${e}`).get()).data().comments;await dbService.doc(`blogs/${e}`).update({comments:[...i,n]}),toastr.success("댓글이 등록 되었습니다.")}catch(e){console.error(e),toastr.error(e)}finally{$blog_comment_write.find(".comment_content").val("").focus()}})()})),$blog_comment_list.on("click",".btn_delete_comment",(function(e){const n=$.urlParam("id"),i=$(this).closest("li").index(),o=$(this).closest("ul").find("li").length-1-i;console.log(o),t(n,o)}));const t=async(e,t)=>{try{const n=(await dbService.doc(`blogs/${e}`).get()).data().comments;n.splice(t,1),await dbService.doc(`blogs/${e}`).update({comments:n}),toastr.success("댓글을 삭제했습니다.")}catch(e){console.error(e),toastr.error("댓글 삭제를 실패했습니다.")}};if(PAGE_BLOG){let e=!1,t=null,n=null;const i="desc",o=async o=>{try{$loading_all.show(),$loading_all_ui.show();const e=blogRef.orderBy("createdAt",i);n="asc"===i?await e.startAfter(o||0).limit(10):o?await e.startAfter(o).limit(10):await e.limit(10);const a=await n.get();let l="";a.docs.forEach((e=>{const t={...e.data(),id:e.id},n=t.attachmentUrl;l+=`<li title=${t.id}>\n                    <a href="./blog_detail.asp?id=${t.id}">\n                        <div class="detail_wrp">\n                            ${n?"<span class='pic_wrp'><img src="+n+" alt='' /></span>":""}\n                            <div class="con_wrp">\n                                <span class="title">${t.title}</span>\n                                <span class="content">${transformTextType3(t.content)}</span>\n                            </div>\n                        </div>\n                        <div class="author_wrp">\n                            <div class="author_wrap">\n                                <span class="face"><img src="images/char${getUserFace(t.creatorId)}.png" alt=${t.author}></span>\n                                <span class="author"><strong>${t.author}</strong></span>\n                            </div>\n                            <span class="info">${moment(t.createdAt).fromNow()} · <i class='bx bx-comment'></i>${t.comments.length}</span>\n                        </div>\n                    </a>\n                </li>`})),$blog_list.append(l),t=a.docs[a.docs.length-1],a.empty&&(toastr.success("더 이상 불러올 게시글이 없습니다."),document.removeEventListener("scroll",s))}catch(e){console.error("getBlogsItem 함수 내부 에러 : ",e)}finally{$blog_loading.hide(),$loading_all.hide(),$loading_all_ui.hide(),e=!1}};window.addEventListener("DOMContentLoaded",(()=>o()));const s=()=>{window.pageYOffset+document.documentElement.clientHeight>document.documentElement.scrollHeight-100&&!e&&(e=!0,o(t))};document.addEventListener("scroll",s)}})(),(()=>{0!==window.location.pathname.indexOf("/items/")&&0!==window.location.pathname.indexOf("/pages/")||($loading_all.show(),$loading_all_ui.show());const e=()=>{const e=$tweet_input_all.find(".tweet").val();if(e.length>4999)return toastr.error("5000자 이상 입력할 수 없습니다.");if(""===e.trim())return toastr.error("값을 입력하세요.");const t={text:e,createdAt:Date.now(),author:USER_NAME,creatorId:USER_ID};$tweet_input_all.find("button").addClass("pending"),tweetRef.add(t).then((()=>{$tweet_input_all.find(".tweet").val("").focus(),$tweet_input_all.find("button").removeClass("pending")})),$tweet_box_all.animate({scrollTop:$tweet_list_all.height()},400)},t=()=>{const e=$tweet_input_item.find(".tweet").val(),t=$(".select_wrap").find(".selected").text(),n=$(".select_wrap").find(".selected").val();if(e.length>4999)return toastr.error("5000자 이상 입력할 수 없습니다.");if($(".select_wrap a").hasClass("selected"))return toastr.error(isPathname.toUpperCase()+" 타입을 선택하세요.");if(""===e.trim())return toastr.error("값을 입력하세요.");const i={text:e,createdAt:Date.now(),author:USER_NAME,creatorId:USER_ID,optionText:t,optionValue:n,comments:[],completed:!1};$tweet_input_item.find("button").addClass("pending"),tweetRefItem.add(i).then((()=>{$tweet_input_item.find(".tweet").val("").focus(),$tweet_input_item.find("button").removeClass("pending")})),$tweet_box_item.animate({scrollTop:$tweet_list_item.height()},400)},n=async(e,t)=>{const n=$(".issue-box[data-id="+e+"]"),i=n.find(".input-area input.tweet").val();if(i.length>4999)return toastr.error("5000자 이상 입력할 수 없습니다.");if(""===i.trim())return toastr.error("값을 입력하세요.");const o={content:i,createdAt:Date.now(),author:USER_NAME,creatorId:USER_ID};await dbService.doc(`tweetsBy${isPathname}/${e}`).update({comments:[...t,o]}),toastr.success("댓글이 등록 되었습니다."),n.find(".input-area input.tweet").val("").focus()};$tweet_input_all.find(".tweet").on("keyup",(t=>{13===t.keyCode&&e()})),$tweet_input_all.find("button").on("click",(t=>{t.preventDefault(),e()})),$tweet_input_item.find(".tweet").on("keyup",(e=>{13===e.keyCode&&t()})),$tweet_input_item.find("button").on("click",(e=>{e.preventDefault(),t()})),$tweet_list_all.on("click",".btns.btns1 .btn.delete",(function(){if(window.confirm("게시글을 삭제하시겠습니까?")){const e=$(this).closest("li").find("span.tid").text();dbService.doc(`tweets/${e}`).delete()}})).on("click",".btns.btns1 .btn.edit",(function(){const e=$(this).closest("li"),t=e.find("span.tid").text(),n=e.find("span.tweet").text();e.find(".btns.btns1").hide(),e.find(".btns.btns2").show(),e.find("span.tweet").hide(),e.prepend(`<input id=${t} class="edit" />`),e.find("input.edit").focus(),e.find("input.edit").val(n)})).on("click",".btns.btns2 .btn.edit",(function(){const e=$(this).closest("li"),t=e.find("span.tid").text();dbService.doc(`tweets/${t}`).update({text:e.find("input.edit").val()})})).on("click",".btns.btns2 .btn.cancel",(function(){const e=$(this).closest("li");e.find("input.edit").remove(),e.find("span.tweet").show(),e.find(".btns.btns1").show(),e.find(".btns.btns2").hide()})),$tweet_list_item.on("click",".btns.btns1 .btn.delete",(function(){if(window.confirm("게시글을 삭제하시겠습니까?")){const e=$(this).closest("li").find("span.tid").text();dbService.doc(`tweetsBy${isPathname}/${e}`).delete()}})).on("click",".btns.btns1 .btn.edit",(function(){const e=$(this).closest("li"),t=e.find("span.tid").text(),n=e.find("span.tweet").text();e.find(".btns.btns1").hide(),e.find(".btns.btns2").show(),e.find("span.tweet").hide(),e.prepend(`<input id=${t} class="edit" />`),e.find("input.edit").focus(),e.find("input.edit").val(n)})).on("click",".btns.btns2 .btn.edit",(function(){const e=$(this).closest("li"),t=e.find("span.tid").text();dbService.doc(`tweetsBy${isPathname}/${t}`).update({text:e.find("input.edit").val()})})).on("click",".btns.btns2 .btn.cancel",(function(){const e=$(this).closest("li");e.find("input.edit").remove(),e.find("span.tweet").show(),e.find(".btns.btns1").show(),e.find(".btns.btns2").hide()})).on("click","span.tweet, .wrap_design, span.comments",(function(){var e=$(this).siblings(".ttype").text();fnMove(e)})),$(".page_text_wrap").on("click",".issue_wrap > a",(function(e){e.preventDefault(),$(this).hasClass("on")?($(this).removeClass("on"),$(this).next(".issue_con").removeClass("on"),$(this).siblings(".issue-box-wrap").css("z-index",1)):($(".issue_wrap > a").removeClass("on"),$(".issue-box .issue_con.on").removeClass("on"),$(".issue-box-wrap").css("z-index",1),$(this).addClass("on"),$(this).next(".issue_con").addClass("on"),$(this).siblings(".dim_issue").addClass("on"),$(this).siblings(".issue-box-wrap").css("z-index",2),$(this).next(".issue_con").find(".issue_chat_wrap").animate({scrollTop:$(this).next(".issue_con").find(".issue_chat_area").height()},300))})).on("click",".issue_wrap .input-area .btn.action",(function(e){n($(this).closest(".issue-box").data("id"),$(this).closest(".issue-box").data("comments"))})).on("keyup",".issue_wrap .input-area input.tweet",(function(e){13===e.keyCode&&n($(this).closest(".issue-box").data("id"),$(this).closest(".issue-box").data("comments"))})).on("change",".chk-base input",(function(){dbService.doc(`tweetsBy${isPathname}/${$(this).closest(".issue-box").data("id")}`).update({completed:$(this).is(":checked")}).then((()=>{$(this).is(":checked")?toastr.success("해당 일감이 해결되었습니다."):toastr.success("해당 일감이 미해결 상태로 왼복 왔습니다.")})).catch((e=>{toastr.error(e)}))})).on("click",".btn-del-issue",(function(e){if(e.preventDefault(),confirm("해당 이슈를 삭제하시겠습니까?")){const e=$(this).closest(".issue-box").data("id");dbService.doc(`tweetsBy${isPathname}/${e}`).delete().then((()=>{toastr.success("이슈를 삭제하였습니다.")})).catch((e=>{}))}else toastr.success("이슈 삭제를 취소하셨습니다.")})).on("click",".login_close_btn",(function(e){e.preventDefault(),$(".dim_issue").removeClass("on"),$(".issue_wrap > a").removeClass("on"),$(".issue-box .issue_con.on").removeClass("on"),$(".issue-box-wrap").css("z-index",1)})),$(document).on("click",(function(e){$(e.target).closest(".issue-box").length||($(".issue_wrap > a").removeClass("on"),$(".issue-box .issue_con.on").removeClass("on"),$(".issue-box-wrap").css("z-index",1),$(".dim_issue").removeClass("on"))}))})();